(function(window){"use strict";var jQ;var HOST_PRODUCTION="//login.sendpulse.com";var HOST_DEVELOPMENT="//login.sendpulse.dev";function SPForm(id){var self=this;window.SPFormRegistry=window.SPFormRegistry||{};self.id=id;self.formSelector="#sp-form-"+self.id;self.$form=jQ(self.formSelector);self.$formMessage=jQ(self.formSelector+" .sp-message");self.$formOuter=jQ(self.formSelector).parent(".subscribe-form");self.$submitButton=jQ(self.formSelector+" button.form-button");self.$closeButton=jQ(self.formSelector+" .sp-btn-close");self.formHash=self.$form.attr("sp-hash");self.formType=self.$form.hasClass("sp-form-popup")?"popup":"embed";self.formType=self.$form.hasClass("sp-form-fixed")?"fixed":self.formType;self.inputs={};self.inputsSelector=self.formSelector+" .sp-element-container :input";self.language=self.$form.attr("sp-lang");self.preparedData={};self.sent=false;self.showOptions={};self.submitURL=HOST_PRODUCTION;self.submitURL+="/members/forms/jsonp-submit";self.history=new SPHistory(self.formHash);self.valid=true;self.ipInfo={};self.previewMode=window.location.hostname==="forms.sendpulse.com";self.init()}SPForm.prototype.init=function(){var self=this;self.$closeButton.on("click",function(e){self.close(e)});self.$submitButton.prop("disabled",!self.valid);jQ(self.inputsSelector).each(function(i,e){var $input=jQ(e);$input.hideTip=function(){if($input.hasClass("subscribe-form-invalid")){this.removeClass("subscribe-form-invalid");this.next(".subscribe-form-popup").detach()}};$input.showTip=function(type){var tips=JSON.parse(decodeURIComponent(this.attr("sp-tips")));this.addClass("subscribe-form-invalid");if(tips.hasOwnProperty(type)){this.after(jQ("<div/>",{class:"subscribe-form-popup subscribe-form-invalid",html:tips[type]}))}};$input.on("focus",function(e){self.hideAllTips()});if($input.attr("name")==="sform[phone]"){$input.intlTelInput({initialCountry:"auto",separateDialCode:true,geoIpLookup:function(callback){jQ.get("//ipinfo.io",function(){},"jsonp").always(function(resp){self.ipInfo=resp;var countryCode=resp&&resp.country?resp.country:"";callback(countryCode)})},utilScript:"//cdnjs.cloudflare.com/ajax/libs/intl-tel-input/9.2.4/js/utils.js"})}self.inputs[e.name]=$input});self.$submitButton.off("click").on("click",function(e){self.submit()});if(self.previewMode){self.$form.removeClass("sp-form-popup");self.$form.removeClass("sp-form-fixed");self.$formOuter.removeClass("sp-popup-outer");self.$closeButton.remove()}return self};SPForm.prototype.run=function(){var self=this;self.show()};SPForm.prototype.hideAllTips=function(){var self=this;for(var i in self.inputs){if(self.inputs.hasOwnProperty(i)&&self.inputs[i].hasOwnProperty("hideTip")){self.inputs[i].hideTip()}}};SPForm.prototype.disableInputs=function(){var self=this;jQ(self.inputsSelector).prop("disabled",true);self.$submitButton.prop("disabled",true)};SPForm.prototype.close=function(e){var self=this;self.$formOuter.addClass("sp-hide");if(!self.history.getSubmits().length){self.history.addReject((new Date).getTime())}};SPForm.prototype.show=function(){var self=this;self.$formOuter.removeClass("sp-force-hide");self.history.addLastShow();if(self.previewMode){raiseForm();return}if(self.formType!=="embed"){if(self.history.getSubmits().length){return}if(self.history.getRejects().length>1){return}if(self.history.getRejects().length===1){var now=(new Date).getTime();var diffInDays=(now-self.history.getLastShow())/864e5;if(self.showOptions.repeat>0&&diffInDays<self.showOptions.repeat){return}}if(self.formType==="popup"){showPopup()}if(self.formType==="fixed"){raiseForm()}}function showPopup(){switch(self.showOptions.condition){case"onEnter":raiseForm(self.showOptions.delay);break;case"onScroll":jQ(window).scroll(function(){if(jQ(window).scrollTop()+jQ(window).height()===jQ(document).height()){raiseForm()}});break;case"onClose":jQ(window).on("unload",function(e){e.preventDefault();raiseForm()});break;default:}}function raiseForm(delay){delay=delay||.2;delay*=1e3;setTimeout(function(){self.$formOuter.addClass("sp-showing");setTimeout(function(){self.$formOuter.addClass("sp-show")},200);setTimeout(function(){self.$formOuter.removeClass("sp-showing")},400)},delay)}};SPForm.prototype.validateAll=function(){var self=this;self.valid=true;for(var i in self.inputs){if(self.inputs.hasOwnProperty(i)&&self.inputs[i].attr("sp-type")!==undefined){var $input=self.inputs[i];var result=self.validate($input);self.valid=self.valid&&result}}return self};SPForm.prototype.validate=function($input){var self=this;var type=$input.attr("sp-type");if(type===undefined){return true}if($input.name==="sform[phone]"){type="phone"}var valid=true;var value=$input.val();$input.hideTip();if($input.prop("required")&&value===""){valid=false;$input.showTip("required");self.$submitButton.prop("disabled",false);return valid}if(valid&&value!==""){switch(type){case"address":valid=isValidAddress(value);break;case"date":valid=isValidDate(value);break;case"email":valid=isValidEmail(value);break;case"phone":if($input.prop("required")){valid=isValidPhone($input)}break;default:}}if(!valid){$input.showTip("wrong")}return valid;function isValidAddress(value){return true}function isValidDate(value){return true}function isValidEmail(value){var re=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return re.test(value)}function isValidPhone(value){return jQ.trim($input.val())?$input.intlTelInput("isValidNumber"):false}};SPForm.prototype.cbSubmit=function(response){var self=this;if(response.hasOwnProperty("html")&&response.hasOwnProperty("status")){if(response.status==="success"){self.$formMessage.addClass("sp-message-success");self.sent=true;$(".subscribe-form-field").hide();self.history.addSubmit()}else{self.$formMessage.addClass("sp-message-error")}self.$formMessage.html(response.html)}self.removeInstanceFromRegistry()};SPForm.prototype.submit=function(){var self=this;if(self.formType==="popup"&&self.history.getSubmits().length>1){throw new Error("Form has been submitted twice already. Enough!")}if(!self.sent){self.validateAll();if(self.valid){self.putInstanceToRegistry();prepareData();self.disableInputs();send()}}function send(){jQ.ajax({url:self.submitURL+"?callback=?",dataType:"jsonp",data:self.preparedData,jsonpCallback:self.makeCallbackName("cbSubmit")})}function prepareData(){for(var i in self.inputs){if(self.inputs.hasOwnProperty(i)){var input=self.inputs[i];switch(input.attr("sp-type")){case"phone":self.preparedData[i]=input.intlTelInput("getNumber");break;case"checkbox":if(input.prop("checked")){self.preparedData[i]=input.val()}else{self.preparedData[i]="no"}break;case"radio":self.preparedData[i]=jQ('[name="'+i+'"]:checked').val();break;default:self.preparedData[i]=input.val()}}}self.preparedData.sform_lang=self.language;self.preparedData["sform[hash]"]=self.formHash;self.preparedData["sform["+window.btoa("autoSite")+"]"]=window.location.host;if(!jQ.isEmptyObject(self.ipInfo)){self.preparedData["sform["+window.btoa("autoIp")+"]"]=self.ipInfo.ip;self.preparedData["sform["+window.btoa("autoCity")+"]"]=self.ipInfo.city;self.preparedData["sform["+window.btoa("autoRegion")+"]"]=self.ipInfo.region;self.preparedData["sform["+window.btoa("autoCountry")+"]"]=self.ipInfo.country}}};SPForm.prototype.makeCallbackName=function(method){var self=this;return"SPFormRegistry['"+self.formHash+"']."+method};SPForm.prototype.putInstanceToRegistry=function(){var self=this;window.SPFormRegistry[self.formHash]=self};SPForm.prototype.removeInstanceFromRegistry=function(){var self=this;if(window.SPFormRegistry[self.formHash]!==undefined){delete window.SPFormRegistry[self.formHash]}};function SPHistory(formHash){var self=this;self.formHash=formHash;self.all=self.raise()}SPHistory.prototype.raise=function(){var self=this;if(localStorage.hasOwnProperty(self.formHash)){try{return JSON.parse(localStorage.getItem(self.formHash))}catch(e){console.error(e)}}return{submits:[],rejects:[],lastShow:0}};SPHistory.prototype.persist=function(){var self=this;localStorage.setItem(self.formHash,JSON.stringify(self.all))};SPHistory.prototype.add=function(key,value){var self=this;value=value||(new Date).getTime();switch(key){case"submits":case"rejects":self.all[key].push(value);break;case"lastShow":self.all[key]=value;break;default:}self.persist()};SPHistory.prototype.addSubmit=function(value){var self=this;self.add("submits",value)};SPHistory.prototype.addReject=function(value){var self=this;self.add("rejects",value)};SPHistory.prototype.addLastShow=function(value){var self=this;self.add("lastShow",value)};SPHistory.prototype.get=function(key){var self=this;if(self.all.hasOwnProperty(key)){return self.all[key]}};SPHistory.prototype.getSubmits=function(){var self=this;return self.get("submits")};SPHistory.prototype.getRejects=function(){var self=this;return self.get("rejects")};SPHistory.prototype.getLastShow=function(){var self=this;return self.get("lastShow")};function ResourceLoader(){}ResourceLoader.loadScript=function(url,callback){return new Promise(function(resolve,reject){var script=document.createElement("script");script.type="text/javascript";script.async=true;script.src=url+"?t="+(new Date).getTime();document.getElementsByTagName("head")[0].appendChild(script);if(script.readyState){script.onreadystatechange=function(){if(script.readyState==="loaded"||script.readyState==="complete"){script.onreadystatechange=null;typeof callback==="function"&&callback();resolve()}}}else{script.onload=function(){typeof callback==="function"&&callback();resolve()}}script.onerror=function(){reject(new Error("Loading fail! "+url))}})};ResourceLoader.loadCss=function(url,callback){return new Promise(function(resolve,reject){var script=document.createElement("link");script.rel="stylesheet";script.media="screen";script.href=url+"?t="+(new Date).getTime();document.getElementsByTagName("head")[0].appendChild(script);if(script.readyState){script.onreadystatechange=function(){if(script.readyState==="loaded"||script.readyState==="complete"){script.onreadystatechange=null;typeof callback==="function"&&callback();resolve()}}}else{script.onload=function(){typeof callback==="function"&&callback();resolve()}}script.onerror=function(){reject(new Error("Loading fail! "+url))}})};ResourceLoader.loadPromisePolyfill=function(callback){var url="//polyfill.io/v2/polyfill.min.js?flags=gated,always&features=Promise,&rum=0";var script=document.createElement("script");script.type="text/javascript";script.async=false;script.src=url+"?t="+(new Date).getTime();document.getElementsByTagName("head")[0].appendChild(script);if(script.readyState){script.onreadystatechange=function(){if(script.readyState==="loaded"||script.readyState==="complete"){script.onreadystatechange=null;typeof callback==="function"&&callback()}}}else{script.onload=function(){typeof callback==="function"&&callback()}}script.onerror=function(){throw new Error("Loading fail! "+url)}};function spBootstrap(callback){var resume=new Promise(function(resolve,reject){if(typeof window.jQuery==="undefined"){ResourceLoader.loadScript("//ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js",function(){jQ=window.jQuery}).then(function(){resolve()})}else{jQ=window.jQuery;resolve()}});resume.then(callback)}function spStart(){var cdnHost="cdn.sendpulse.com";var queue=[];var phone=jQ('div.sp-form [name="sform[phone]"]');var ids=gatherFormsIds();var dep=new Promise(function(resolve,reject){if(phone.length>0){queue.push(ResourceLoader.loadCss("//cdnjs.cloudflare.com/ajax/libs/intl-tel-input/9.2.4/css/intlTelInput.css"));queue.push(ResourceLoader.loadScript("//cdnjs.cloudflare.com/ajax/libs/intl-tel-input/9.2.4/js/intlTelInput.min.js"));queue.push(ResourceLoader.loadScript("//cdnjs.cloudflare.com/ajax/libs/intl-tel-input/9.2.4/js/utils.js"))}Promise.all(queue).then(function(){resolve()},function(reason){console.error("Necessary scripts have not been loaded:",reason)})});dep.then(function(){for(var i=0,l=ids.length;i<l;i++){new SPForm(ids[i]).run()}})}function gatherFormsIds(){var forms=jQ("div.sp-form");var count=forms.length;var ids=[];if(!count){throw new Error("SendPulse: Subscription form ID is missing or code is corrupted!")}for(var i=0;i<count;i++){ids.push(jQ(forms[i]).attr("sp-id"))}return ids}window.onload=function(){var forms=$("div.sp-form");if(!forms.length){console.log("SendPulse: no subscription form on that page. Do not load SendPulse script here!");return}var promisesSupported=typeof Promise!=="undefined"&&Promise.toString().indexOf("[native code]")!==-1;if(promisesSupported){spBootstrap(spStart)}else{ResourceLoader.loadPromisePolyfill(function(){spBootstrap(spStart)})}}})(window);